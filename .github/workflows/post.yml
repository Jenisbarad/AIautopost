# ============================================================
# Instagram Carousel Auto-Poster â€” Unified GitHub Actions Workflow
# @dailyainewsone
#
# FULLY AUTONOMOUS PIPELINE:
#   1. Generate content (Gemini AI)
#   2. Generate slide images (Puppeteer)
#   3. Commit new content + images back to repo
#   4. Post carousel to Instagram using GitHub raw URLs
#
# SCHEDULE (IST â†’ UTC):
#   10:30 AM IST (05:00 UTC) â†’ Post 1
#    1:30 PM IST (08:00 UTC) â†’ Post 2
#    4:30 PM IST (11:00 UTC) â†’ Post 3
#    7:30 PM IST (14:00 UTC) â†’ Post 4
#   10:30 PM IST (17:00 UTC) â†’ Post 5
#
# Content + images are generated on the FIRST run (05:00 UTC).
# Subsequent runs reuse today's content and only post the next carousel.
# ============================================================

name: Post Instagram Carousels

on:
  # â”€â”€â”€ SCHEDULED TRIGGERS (Daily at IST posting times) â”€â”€â”€
  schedule:
    - cron: '0 5 * * *'     # Post 1 â†’ 10:30 AM IST
    - cron: '0 8 * * *'     # Post 2 â†’  1:30 PM IST
    - cron: '0 11 * * *'    # Post 3 â†’  4:30 PM IST
    - cron: '0 14 * * *'    # Post 4 â†’  7:30 PM IST
    - cron: '0 17 * * *'    # Post 5 â†’ 10:30 PM IST

  # â”€â”€â”€ MANUAL TRIGGER (from GitHub UI) â”€â”€â”€
  workflow_dispatch:
    inputs:
      post_index:
        description: 'Which post to publish (1-5, or "all" for all posts)'
        required: true
        default: 'all'
        type: string
      dry_run:
        description: 'Dry run mode â€” generate content + images, show logs, but do NOT post'
        required: false
        default: false
        type: boolean

# Allow the workflow to push commits back to the repo
permissions:
  contents: write

jobs:
  auto-post:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
      INSTAGRAM_ACCOUNT_ID: ${{ secrets.INSTAGRAM_ACCOUNT_ID }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      POST_SPACING_MS: ${{ secrets.POST_SPACING_MS || '10800000' }}
      # Set to "false" if you want to use Gemini again
      DISABLE_GEMINI: 'true'

    steps:
      # â”€â”€â”€ STEP 1: Checkout code â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€ STEP 2: Setup Node.js â”€â”€â”€
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # â”€â”€â”€ STEP 3: Install dependencies (including Puppeteer) â”€â”€â”€
      - name: Install dependencies
        run: npm install

      # â”€â”€â”€ STEP 4: Determine post index and date â”€â”€â”€
      - name: Determine post config
        id: post-config
        run: |
          # Determine target date (IST = UTC+5:30)
          TARGET_DATE=$(TZ='Asia/Kolkata' date '+%Y-%m-%d')

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger â€” use user input
            POST_INDEX="${{ github.event.inputs.post_index }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
          else
            # Scheduled trigger â€” determine post from current UTC hour
            HOUR=$(date -u +%H)
            case $HOUR in
              05) POST_INDEX=1 ;;
              08) POST_INDEX=2 ;;
              11) POST_INDEX=3 ;;
              14) POST_INDEX=4 ;;
              17) POST_INDEX=5 ;;
              *)  POST_INDEX=1 ;;  # Default fallback
            esac
            DRY_RUN="false"
          fi

          echo "post_index=$POST_INDEX" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "target_date=$TARGET_DATE" >> $GITHUB_OUTPUT

          echo "============================================"
          echo "  Target Date: $TARGET_DATE"
          echo "  Post Index:  $POST_INDEX"
          echo "  Dry Run:     $DRY_RUN"
          echo "  Trigger:     ${{ github.event_name }}"
          echo "  Time (UTC):  $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "============================================"

      # â”€â”€â”€ STEP 5: Verify secrets â”€â”€â”€
      - name: Verify secrets are set
        run: |
          MISSING=""
          if [ -z "$INSTAGRAM_ACCESS_TOKEN" ]; then MISSING="$MISSING INSTAGRAM_ACCESS_TOKEN"; fi
          if [ -z "$INSTAGRAM_ACCOUNT_ID" ]; then MISSING="$MISSING INSTAGRAM_ACCOUNT_ID"; fi
          # At least ONE AI provider key must be present; others are optional fallbacks
          DISABLE_GEMINI_LC="$(echo "${DISABLE_GEMINI:-}" | tr '[:upper:]' '[:lower:]')"
          GEMINI_ENABLED="true"
          if [ "$DISABLE_GEMINI_LC" = "1" ] || [ "$DISABLE_GEMINI_LC" = "true" ] || [ "$DISABLE_GEMINI_LC" = "yes" ]; then
            GEMINI_ENABLED="false"
          fi

          if [ -z "$GROQ_API_KEY" ] && [ -z "$OPENROUTER_API_KEY" ] && [ -z "$TOGETHER_API_KEY" ] && { [ "$GEMINI_ENABLED" != "true" ] || [ -z "$GEMINI_API_KEY" ]; }; then
            MISSING="$MISSING (one of GEMINI_API_KEY / GROQ_API_KEY / OPENROUTER_API_KEY / TOGETHER_API_KEY)";
          fi

          if [ -n "$MISSING" ]; then
            echo "ERROR: Missing required secrets:$MISSING"
            echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          echo "All required secrets are configured."

      # â”€â”€â”€ STEP 6: Generate content (if not already generated for today) â”€â”€â”€
      - name: Generate content for today
        run: |
          TARGET_DATE="${{ steps.post-config.outputs.target_date }}"
          CONTENT_FILE="content/${TARGET_DATE}.json"

          if [ -f "$CONTENT_FILE" ]; then
            echo "âœ… Content file exists: $CONTENT_FILE"
            echo "  Validating schema..."
            node -e "const fs=require('fs');const p=process.argv[1];const j=JSON.parse(fs.readFileSync(p,'utf8'));const ok=Array.isArray(j.posts)&&j.posts.length===5&&j.posts.every(x=>x&&x.slideContent&&x.slideContent.slide1&&x.slideContent.slide1.headline&&x.slideContent.slide2&&Array.isArray(x.slideContent.slide2.lines)&&x.slideContent.slide3&&Array.isArray(x.slideContent.slide3.lines)); if(!ok){console.error('Schema invalid (likely old format).'); process.exit(2)}" "$CONTENT_FILE" || {
              echo "ğŸ“ Regenerating content (schema repair/upgrade) for: $TARGET_DATE"
              node src/generate-content.js --date "$TARGET_DATE"
            }
          else
            echo "ğŸ“ Generating new content for: $TARGET_DATE"
            node src/generate-content.js --date "$TARGET_DATE"
          fi

      # â”€â”€â”€ STEP 7: Generate images (if not already captured) â”€â”€â”€
      - name: Generate slide images
        run: |
          TARGET_DATE="${{ steps.post-config.outputs.target_date }}"
          CONTENT_FILE="content/${TARGET_DATE}.json"

          # Count existing captured images
          EXISTING_COUNT=$(ls "images/captured/${TARGET_DATE}"/post*.png 2>/dev/null | wc -l || echo "0")

          if [ "$EXISTING_COUNT" -ge 15 ]; then
            echo "âœ… Found $EXISTING_COUNT slide images for ${TARGET_DATE} â€” skipping regeneration."
          else
            echo "ğŸ–¼ï¸ Generating slide images for ${TARGET_DATE}..."
            node src/generate-images.js --date "$TARGET_DATE"
          fi

      # â”€â”€â”€ STEP 8: Commit new content + images back to repo â”€â”€â”€
      - name: Commit generated content and images
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet && echo "No changes to commit." && exit 0
          git commit -m "Auto: content + images for ${{ steps.post-config.outputs.target_date }} [skip ci]"
          git push

      # â”€â”€â”€ STEP 9: Post carousel to Instagram â”€â”€â”€
      - name: Post carousel to Instagram
        run: |
          POST_INDEX="${{ steps.post-config.outputs.post_index }}"
          DRY_RUN="${{ steps.post-config.outputs.dry_run }}"

          CMD="node src/post-carousels.js"

          if [ "$POST_INDEX" != "all" ]; then
            CMD="$CMD --post-index $POST_INDEX"
          fi

          if [ "$DRY_RUN" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Running: $CMD"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          $CMD

      # â”€â”€â”€ STEP 10: Log result â”€â”€â”€
      - name: Log completion
        if: always()
        run: |
          echo "============================================"
          echo "  Workflow:   ${{ github.workflow }}"
          echo "  Status:     ${{ job.status }}"
          echo "  Date:       ${{ steps.post-config.outputs.target_date }}"
          echo "  Post Index: ${{ steps.post-config.outputs.post_index }}"
          echo "  Dry Run:    ${{ steps.post-config.outputs.dry_run }}"
          echo "  Trigger:    ${{ github.event_name }}"
          echo "  Time (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "  Run ID:     ${{ github.run_id }}"
          echo "============================================"
